name: Deploy from Zip File

on:
  push:
    paths:
      - '**.zip'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy from zip (2-level extraction)
        run: |
          echo "🚀 Starting deployment from zip file..."

          # Find the zip file
          ZIP_FILE=$(find . -maxdepth 1 -name "*.zip" -type f | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ No zip file found in root directory"
            exit 1
          fi
          echo "📦 Found zip file: $ZIP_FILE"
          ZIP_FILENAME=$(basename "$ZIP_FILE")

          # Create and prepare temp directory
          TEMP_DIR="temp_extract"
          rm -rf "$TEMP_DIR"
          mkdir -p "$TEMP_DIR"

          echo "📂 Extracting zip file..."
          unzip -qq "$ZIP_FILE" -d "$TEMP_DIR"
          chmod -R 755 "$TEMP_DIR"

          # === Navigate exactly two levels deep if possible ===
          LEVEL1=$(find "$TEMP_DIR" -mindepth 1 -maxdepth 1 -type d | head -n 1)
          if [ -n "$LEVEL1" ]; then
            CONTENT_DIR="$LEVEL1"
          else
            CONTENT_DIR="$TEMP_DIR"
          fi

          echo "📁 Using content from: $CONTENT_DIR"

          # === Clean root except .git, zip, and temp ===
          echo "🧹 Cleaning repository root..."
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name "$ZIP_FILENAME" ! -name "$TEMP_DIR" -exec rm -rf {} +

          # === Move content to root ===
          echo "📦 Moving content to root..."
          shopt -s dotglob
          mv "$CONTENT_DIR"/* . 2>/dev/null || true
          shopt -u dotglob

          # === Cleanup ===
          echo "🧠 Cleaning up temporary files..."
          rm -rf "$TEMP_DIR"
          rm -f "$ZIP_FILE"

          echo "✅ Deployment ready!"

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A
          if git diff --staged --quiet; then
            echo "ℹ️ No changes to commit"
          else
            git commit -m "🚀 Auto-deploy: Extracted (2-level) and deployed from zip"
            git push
            echo "✅ Changes committed and pushed!"
          fi
